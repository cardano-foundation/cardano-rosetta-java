"use strict";(self.webpackChunkrosetta_docs=self.webpackChunkrosetta_docs||[]).push([[2916],{1198:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"advanced-configuration/pruning","title":"Spent UTXO Pruning","description":"Optimizing disk usage with spent UTXO pruning","source":"@site/docs/advanced-configuration/pruning.md","sourceDirName":"advanced-configuration","slug":"/advanced-configuration/pruning","permalink":"/cardano-rosetta-java/docs/advanced-configuration/pruning","draft":false,"unlisted":false,"editUrl":"https://github.com/cardano-foundation/cardano-rosetta-java/tree/main/docs/docs/advanced-configuration/pruning.md","tags":[],"version":"current","lastUpdatedBy":"Lincon Vidal","lastUpdatedAt":1750768645000,"sidebarPosition":1,"frontMatter":{"sidebar_position":1,"title":"Spent UTXO Pruning","description":"Optimizing disk usage with spent UTXO pruning"},"sidebar":"tutorialSidebar","previous":{"title":"Database Tuning","permalink":"/cardano-rosetta-java/docs/advanced-configuration/db-tuning"},"next":{"title":"Getting Started with H2","permalink":"/cardano-rosetta-java/docs/advanced-configuration/h2-database"}}');var s=i(4848),r=i(8453);const o={sidebar_position:1,title:"Spent UTXO Pruning",description:"Optimizing disk usage with spent UTXO pruning"},a="Spent UTXO Pruning",d={},l=[{value:"Understanding Spent UTXO Pruning",id:"understanding-spent-utxo-pruning",level:2},{value:"Impact on Rosetta API Endpoints",id:"impact-on-rosetta-api-endpoints",level:2},{value:"When Spent UTxO Removal should be enabled?",id:"when-spent-utxo-removal-should-be-enabled",level:2},{value:"When to avoid setting UtxO Removal feature?",id:"when-to-avoid-setting-utxo-removal-feature",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Migration and Operational Notes",id:"migration-and-operational-notes",level:2},{value:"Changing Pruning Settings on an Existing Deployment",id:"changing-pruning-settings-on-an-existing-deployment",level:3},{value:"How to Resynchronize the Indexer",id:"how-to-resynchronize-the-indexer",level:3},{value:"Further Reading",id:"further-reading",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"spent-utxo-pruning",children:"Spent UTXO Pruning"})}),"\n",(0,s.jsxs)(n.p,{children:["This guide explains how to optimize disk usage in ",(0,s.jsx)(n.strong,{children:"cardano-rosetta-java"})," through spent UTXO pruning, including its impact on Rosetta API endpoints and configuration options."]}),"\n",(0,s.jsx)(n.h2,{id:"understanding-spent-utxo-pruning",children:"Understanding Spent UTXO Pruning"}),"\n",(0,s.jsxs)(n.p,{children:["Spent UTXO pruning is a disk optimization mechanism in ",(0,s.jsx)(n.code,{children:"cardano-rosetta-java"}),", powered by its underlying indexer, Yaci-Store. This feature selectively removes data related to spent UTXOs from the local database."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Core Principles:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Targeted Deletion"}),": Only ",(0,s.jsx)(n.em,{children:"spent"})," UTXOs are removed. All ",(0,s.jsx)(n.em,{children:"current, unspent"})," UTXOs are preserved, ensuring the accuracy of the present blockchain state and balances."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Distinction from Other Pruning"}),": This mechanism differs from what is commonly understood as 'pruning' in some other blockchain contexts, including certain descriptions in the Coinbase Mesh API (formerly Rosetta). Unlike methods such as Bitcoin's pruning (which removes entire historical blocks), our approach retains full block history but selectively trims the UTXO set by removing only spent outputs."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"How it Works:"}),"\nWhen enabled, the pruning process operates as follows:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"New UTXOs are indexed as transactions occur."}),"\n",(0,s.jsx)(n.li,{children:"UTXOs are marked as spent when consumed in subsequent transactions."}),"\n",(0,s.jsx)(n.li,{children:"A background job periodically permanently deletes spent UTXOs that are older than a configurable safety margin (default: 2,160 blocks, ~12 hours on mainnet). This buffer safeguards data integrity against chain rollbacks within Cardano's finality window."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Impact Summary:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"Aspect"}),(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"Effect"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"Disk Storage"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u2705 Significantly reduced (e.g., mainnet from ~1TB to ~500GB)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"Current UTXO Set"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u2705 Fully preserved; current balances remain accurate"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"Historical Spent UTXOs"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u26a0\ufe0f Permanently deleted beyond the safety margin"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"Query Performance"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u2705 Improved for queries against the current UTXO set"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"impact-on-rosetta-api-endpoints",children:"Impact on Rosetta API Endpoints"}),"\n",(0,s.jsx)(n.p,{children:'Spent UTXO pruning affects Rosetta API endpoints differently based on their reliance on historical transaction data. The table below summarizes the impact. Note that "Recent" refers to data within the safety margin (default ~12 hours).'}),"\n",(0,s.jsx)(n.admonition,{title:"Oldest Block Identifier",type:"info",children:(0,s.jsxs)(n.p,{children:["When pruning is enabled, the ",(0,s.jsx)(n.code,{children:"/network/status"})," endpoint includes an additional ",(0,s.jsx)(n.code,{children:"oldest_block_identifier"})," object in its response. This identifier corresponds to the latest fully queryable block with complete data. Below this block index, blocks might have missing data due to pruning, making historical queries unreliable."]})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:(0,s.jsx)(n.strong,{children:"Endpoint"})}),(0,s.jsx)(n.th,{children:(0,s.jsx)(n.strong,{children:"Current State"})}),(0,s.jsx)(n.th,{children:(0,s.jsx)(n.strong,{children:"Historical Queries"})}),(0,s.jsx)(n.th,{children:(0,s.jsx)(n.strong,{children:"Impact & Notes"})})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/account/balance"})}),(0,s.jsx)(n.td,{children:"\u2705 Works"}),(0,s.jsx)(n.td,{children:"\u26a0\ufe0f Limited"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"Low"})," - Current balances unaffected"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/account/coins"})}),(0,s.jsx)(n.td,{children:"\u2705 Works"}),(0,s.jsx)(n.td,{children:"\u26a0\ufe0f Limited"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"Low"})," - Current UTXO lists complete"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/block"})}),(0,s.jsx)(n.td,{children:"\u2705 Recent only"}),(0,s.jsx)(n.td,{children:"\u274c Incomplete"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"High"})," - Missing old transaction inputs"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/block/transaction"})}),(0,s.jsx)(n.td,{children:"\u2705 Recent only"}),(0,s.jsx)(n.td,{children:"\u274c Incomplete"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"High"})," - Missing spent UTXOs operation details"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/search/transactions"})}),(0,s.jsx)(n.td,{children:"\u26a0\ufe0f Recent only"}),(0,s.jsx)(n.td,{children:"\u274c Limited"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"Medium"})," - Hash search works, address limited"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/network/status"})}),(0,s.jsx)(n.td,{children:"\u2705 Works"}),(0,s.jsx)(n.td,{children:"\u2705 Works"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"None"})," - Returns additional ",(0,s.jsx)(n.code,{children:"oldest_block_identifier"})," when pruning enabled"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/network/*"})}),(0,s.jsx)(n.td,{children:"\u2705 Works"}),(0,s.jsx)(n.td,{children:"\u2705 Works"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"None"})," - Independent of UTXO data"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/construction/*"})}),(0,s.jsx)(n.td,{children:"\u2705 Works"}),(0,s.jsx)(n.td,{children:"\u2705 Works"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"None"})," - Uses current UTXOs only"]})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"After enabling pruning, searching for transactions by their hash will always work, because transaction records themselves are never pruned. However, searching by address is limited: address-based searches rely on the UTXO set, and once spent UTXOs older than the pruning window are deleted, only transactions involving current or recently spent UTXOs can be found by address. Older history is not returned once pruned."}),"\n",(0,s.jsx)(n.h2,{id:"when-spent-utxo-removal-should-be-enabled",children:"When Spent UTxO Removal should be enabled?"}),"\n",(0,s.jsxs)(n.admonition,{title:"Recommended Use Cases",type:"tip",children:[(0,s.jsx)(n.p,{children:"Pruning is beneficial in scenarios where optimizing disk space and focusing on current data is prioritized over maintaining a complete historical record. Consider enabling pruning if your use case aligns with the following:"}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Exchange Integrations & Wallet Services"}),": Primarily for tracking current balances, processing recent deposits/withdrawals, and validating recent transactions."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Resource-Constrained Environments"}),": Ideal when disk space is a significant limitation (e.g., under 1TB available for mainnet data)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Tip-of-Chain Operations"}),": For applications focused on the latest blockchain state rather than deep historical analysis."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Development and Testing"}),": Useful when a full historical dataset is not essential for development or testing purposes."]}),"\n"]})]}),"\n",(0,s.jsx)(n.h2,{id:"when-to-avoid-setting-utxo-removal-feature",children:"When to avoid setting UtxO Removal feature?"}),"\n",(0,s.jsxs)(n.admonition,{title:"Not Suitable For",type:"warning",children:[(0,s.jsx)(n.p,{children:"Avoid pruning if your operational or regulatory requirements necessitate access to complete and auditable historical blockchain data. Pruning is generally not suitable if you need:"}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Complete Historical Data & Deep Queries"}),": For comprehensive auditing, compliance, data analytics, or block explorer-like functionality that requires querying full transaction history from any point in time."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Strict Compliance and Audit Trails"}),": If regulatory mandates demand immutable, complete historical records. Pruned data cannot be recovered without a full resync, and historical queries for ",(0,s.jsx)(n.code,{children:"/block"})," and ",(0,s.jsx)(n.code,{children:"/block/transaction"})," become unreliable beyond the safety window."]}),"\n"]})]}),"\n",(0,s.jsx)(n.admonition,{title:"Data Loss Warning",type:"danger",children:(0,s.jsx)(n.p,{children:"Once data is pruned, it cannot be recovered without a full blockchain resynchronization. Assess your historical data needs carefully before enabling pruning."})}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["Spent UTXO pruning is configured via environment variables, typically set in your ",(0,s.jsx)(n.code,{children:".env.dockerfile"})," or ",(0,s.jsx)(n.code,{children:".env.docker-compose"})," file:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# --- Spent UTXO Pruning Configuration ---\n\n# Enable or disable spent UTXO pruning.\n# Default: false (Pruning is disabled by default)\n# To enable, set to: true\nREMOVE_SPENT_UTXOS=true\n\n# Safety margin: Number of recent blocks for which spent UTXOs are retained.\n# Default: 2160 (approximately 12 hours of blocks on mainnet)\n# This value balances safety for rollbacks against storage savings.\n# Example: To keep ~24 hours of spent UTXOs, set to 4320.\n# Note: Larger REMOVE_SPENT_UTXOS_LAST_BLOCKS_GRACE_COUNT values provide longer historical query support\n# but use more disk space and delay the realization of storage benefits.\nREMOVE_SPENT_UTXOS_LAST_BLOCKS_GRACE_COUNT=2160\n"})}),"\n",(0,s.jsx)(n.admonition,{title:"Configuration Guidelines",type:"note",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Start with the default settings (",(0,s.jsx)(n.code,{children:"REMOVE_SPENT_UTXOS=false"})," keeps pruning off)."]}),"\n",(0,s.jsxs)(n.li,{children:["The provided defaults (",(0,s.jsx)(n.code,{children:"REMOVE_SPENT_UTXOS_LAST_BLOCKS_GRACE_COUNT=2160"}),") offer ~12 h of rollback safety on mainnet."]}),"\n",(0,s.jsxs)(n.li,{children:["Increase ",(0,s.jsx)(n.code,{children:"REMOVE_SPENT_UTXOS_LAST_BLOCKS_GRACE_COUNT"})," if you need a longer historical query window; decrease it for more aggressive space savings."]}),"\n"]})}),"\n",(0,s.jsx)(n.h2,{id:"migration-and-operational-notes",children:"Migration and Operational Notes"}),"\n",(0,s.jsx)(n.p,{children:"This section outlines key considerations when changing pruning settings or managing a system with pruning enabled."}),"\n",(0,s.jsx)(n.h3,{id:"changing-pruning-settings-on-an-existing-deployment",children:"Changing Pruning Settings on an Existing Deployment"}),"\n",(0,s.jsxs)(n.p,{children:["To change the pruning configuration, update the ",(0,s.jsx)(n.code,{children:"REMOVE_SPENT_UTXOS"})," variable in your environment (to either ",(0,s.jsx)(n.code,{children:"true"})," or ",(0,s.jsx)(n.code,{children:"false"}),") and restart your ",(0,s.jsx)(n.code,{children:"cardano-rosetta-java"})," services."]}),"\n",(0,s.jsxs)(n.admonition,{title:"Resynchronization Is Required to Apply Changes",type:"info",children:[(0,s.jsxs)(n.p,{children:["It is critical to understand that this change ",(0,s.jsx)(n.strong,{children:"only affects how new blocks are handled"}),"; it does not retroactively alter your existing database. To fully apply the new setting across all historical data, you must perform an ",(0,s.jsx)(n.a,{href:"#how-to-resynchronize-the-indexer",children:"indexer resynchronization"}),"."]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsxs)(n.strong,{children:["When enabling pruning (",(0,s.jsx)(n.code,{children:"true"}),")"]}),", a resync is required to clear out historically spent UTXOs and reclaim disk space."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsxs)(n.strong,{children:["When disabling pruning (",(0,s.jsx)(n.code,{children:"false"}),")"]}),", a resync is required to rebuild the complete transaction history that was previously pruned away."]}),"\n"]}),(0,s.jsx)(n.p,{children:"Without a resynchronization, your database will exist in a mixed state, and you will not see the expected results of your configuration change immediately."})]}),"\n",(0,s.jsx)(n.h3,{id:"how-to-resynchronize-the-indexer",children:"How to Resynchronize the Indexer"}),"\n",(0,s.jsx)(n.p,{children:"The resynchronization process rebuilds the indexer database from your existing Cardano node data, which is much faster than resyncing the entire blockchain from scratch."}),"\n",(0,s.jsx)(n.p,{children:"This is necessary in two main scenarios:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"To reclaim disk space"}),": When you enable pruning on an existing instance, a resync will clear out historically spent UTXOs."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"To restore full history"}),": When you disable pruning, a resync will rebuild the complete transaction history that was previously pruned away."]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{title:"Quick Resynchronization Steps",type:"tip",children:(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Stop the stack"}),": Gracefully shut down your services using ",(0,s.jsx)(n.code,{children:"docker compose down"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Remove the indexer volume"}),": Delete the persistent storage used by the indexer's Postgres database (do ",(0,s.jsx)(n.strong,{children:"not"})," touch the Cardano node data)."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# If your compose file uses a **bind mount** (default):\nsudo rm -rf ${DB_PATH}        # replace ${DB_PATH} with the value from your .env file\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Restart the stack"}),": Start the services again with ",(0,s.jsx)(n.code,{children:"docker compose up -d"}),". The indexer will begin resyncing from the node, applying your new configuration."]}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(n.admonition,{title:"Do Not Delete Cardano Node Data",type:"danger",children:(0,s.jsx)(n.p,{children:"Removing the node's data volume is unnecessary for this process and will trigger a full, time-consuming blockchain resynchronization, leading to significant downtime."})}),"\n",(0,s.jsx)(n.h2,{id:"further-reading",children:"Further Reading"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/cardano-rosetta-java/docs/install-and-deploy/env-vars",children:"Environment Variables Reference"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/bloxbean/yaci-store",children:"Yaci-Store Repository"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.cdp.coinbase.com/mesh/docs/api-reference/",children:"Coinbase Mesh (formerly Rosetta) API Specification"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.cardano.org/learn/eutxo-explainer/",children:"Cardano UTXO Model Documentation"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>a});var t=i(6540);const s={},r=t.createContext(s);function o(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);