services:
  # Snapshot creation service
  # Usage: docker compose -f docker-compose-snapshot.yaml --env-file .env.docker-compose-preprod up db-snapshot-create
  db-snapshot-create:
    image: cardanofoundation/cardano-rosetta-java-postgres:${PG_VERSION_TAG}
    build:
      context: ./
      dockerfile: ./docker/dockerfiles/postgres/Dockerfile
    environment:
      DB_HOST: db
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_SECRET: ${DB_SECRET}
      DB_SCHEMA: ${DB_SCHEMA}
      NETWORK: ${NETWORK}
      SNAPSHOT_DIR: ${SNAPSHOT_DIR:-/snapshots}
      SNAPSHOT_THREADS: ${SNAPSHOT_THREADS:-8}
      PGPASSWORD: ${DB_SECRET}

      # API connection for sync check
      API_HOST: ${API_HOST:-api}
      API_PORT: ${API_PORT:-8082}
      MAX_SYNC_WAIT: ${MAX_SYNC_WAIT:-3600}
    volumes:
      - ./docker/dockerfiles/postgres/create-snapshot.sh:/create-snapshot.sh
      - ${SNAPSHOT_PATH:-./snapshots}:/snapshots
    entrypoint: ["/bin/bash", "/create-snapshot.sh"]
    restart: "no"
    depends_on:
      db:
        condition: service_healthy

networks:
  default:
    name: cardano-rosetta-java-${NETWORK}
    external: true
