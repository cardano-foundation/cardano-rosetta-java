{{- if .Values.global.mithril.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ printf "%s-mithril" .Release.Name }}
  namespace: {{ include "cardano-rosetta-java.namespace" . }}
  labels:
    {{- include "cardano-rosetta-java.commonLabels" . | nindent 4 }}
    component: mithril
  annotations:
    helm.sh/resource-policy: keep
spec:
  backoffLimit: 2
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: {{ printf "%s-mithril" .Release.Name }}
        component: mithril
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ printf "%s-sa" .Release.Name }}
      initContainers:
        - name: check-existing-db
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              if [ -d /node/db ] && [ "$(ls -A /node/db 2>/dev/null)" ]; then
                echo "Node DB already exists ($(du -sh /node/db 2>/dev/null | cut -f1)), skipping Mithril download"
                exit 0
              fi
              echo "No existing node DB found, proceeding with Mithril download"
          volumeMounts:
            - name: node-data
              mountPath: /node
      containers:
        - name: mithril
          image: "cardanofoundation/cardano-rosetta-java-mithril:{{ .Values.global.mithrilVersion }}"
          env:
            - name: NETWORK
              value: {{ .Values.global.network | quote }}
            - name: MITHRIL_SYNC
              value: {{ .Values.global.mithril.sync | toString | quote }}
            - name: SNAPSHOT_DIGEST
              value: {{ .Values.global.mithril.snapshotDigest | quote }}
            - name: AGGREGATOR_ENDPOINT
              value: {{ .Values.global.mithril.aggregatorEndpoint | quote }}
            - name: GENESIS_VERIFICATION_KEY
              value: {{ .Values.global.mithril.genesisVerificationKey | quote }}
            - name: ANCILLARY_VERIFICATION_KEY
              value: {{ .Values.global.mithril.ancillaryVerificationKey | quote }}
          volumeMounts:
            - name: node-data
              mountPath: /node
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "2"
              memory: "2Gi"
      volumes:
        - name: node-data
          persistentVolumeClaim:
            claimName: {{ printf "%s-cardano-node-data" .Release.Name }}
{{- end }}
