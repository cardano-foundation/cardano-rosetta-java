name: Mainnet Snapshot Creation 

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_sync_check:
        description: 'Skip indexer sync check (use with caution)'
        required: false
        type: boolean
        default: false

  # Scheduled: Daily at midnight UTC
  schedule:
    - cron: '0 0 * * *'

env:
  COMPOSE_PROJECT_NAME: cardano-rosetta-java
  API_HOST: localhost
  API_PORT: 8082

jobs:
  detect-network:
    name: Detect Network
    runs-on: [snapshot-server-colo2]
    outputs:
      network: ${{ steps.detect.outputs.network }}
      env_file: ${{ steps.detect.outputs.env_file }}
      yaci_container: ${{ steps.detect.outputs.yaci_container }}

    steps:
      - name: Detect network from Docker networks
        id: detect
        run: |
          echo "üîç Detecting network from running Docker networks..."

          # Find cardano-rosetta-java networks
          NETWORKS=$(docker network ls --format '{{.Name}}' | grep '^cardano-rosetta-java-' || true)

          if [ -z "$NETWORKS" ]; then
            echo "‚ùå ERROR: No cardano-rosetta-java networks found"
            echo "Available networks:"
            docker network ls
            exit 1
          fi

          # Extract network name (e.g., cardano-rosetta-java-preprod -> preprod)
          NETWORK=$(echo "$NETWORKS" | head -1 | sed 's/^cardano-rosetta-java-//')

          echo "‚úÖ Detected network: ${NETWORK}"

          # Determine env file based on network
          if [ "$NETWORK" = "mainnet" ]; then
            ENV_FILE=".env.docker-compose"
          else
            ENV_FILE=".env.docker-compose-${NETWORK}"
          fi

          # Verify env file exists
          if [ ! -f "/home/integration/git/cardano-rosetta-java/${ENV_FILE}" ]; then
            echo "‚ùå ERROR: Environment file not found: ${ENV_FILE}"
            exit 1
          fi

          echo "‚úÖ Using env file: ${ENV_FILE}"

          # Set container name
          YACI_CONTAINER="cardano-rosetta-java-yaci-indexer-1"

          # Verify container is running
          if ! docker ps --format '{{.Names}}' | grep -q "^${YACI_CONTAINER}$"; then
            echo "‚ùå ERROR: Container '${YACI_CONTAINER}' is not running"
            echo "Running containers:"
            docker ps --format '{{.Names}}'
            exit 1
          fi

          echo "‚úÖ Found running container: ${YACI_CONTAINER}"

          # Set outputs
          echo "network=${NETWORK}" >> $GITHUB_OUTPUT
          echo "env_file=${ENV_FILE}" >> $GITHUB_OUTPUT
          echo "yaci_container=${YACI_CONTAINER}" >> $GITHUB_OUTPUT

          echo ""
          echo "üìã Configuration:"
          echo "   Network: ${NETWORK}"
          echo "   Env File: ${ENV_FILE}"
          echo "   Container: ${YACI_CONTAINER}"

  check-sync-status:
    name: Check Indexer Sync Status
    runs-on: [snapshot-server-colo2]
    needs: detect-network
    outputs:
      is_synced: ${{ steps.sync-check.outputs.synced }}

    steps:
      - name: Check indexer is running
        env:
          YACI_CONTAINER: ${{ needs.detect-network.outputs.yaci_container }}
        run: |
          if ! docker ps --format '{{.Names}}' | grep -q "^${YACI_CONTAINER}$"; then
            echo "‚ùå ERROR: Indexer container '${YACI_CONTAINER}' is not running"
            exit 1
          fi
          echo "‚úÖ Indexer container is running"

      - name: Wait for indexer to sync
        id: sync-check
        if: ${{ !inputs.skip_sync_check }}
        env:
          NETWORK: ${{ needs.detect-network.outputs.network }}
        run: |
          echo "üîç Checking indexer sync status for network: ${NETWORK}..."
          MAX_ATTEMPTS=12  # Check every 5 minutes for 1 hour
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESPONSE=$(curl -s --location "${API_HOST}:${API_PORT}/network/status" \
              --header 'Content-Type: application/json' \
              --data "{
                \"network_identifier\": {
                  \"blockchain\": \"cardano\",
                  \"network\": \"${NETWORK}\"
                },
                \"metadata\": {}
              }" 2>/dev/null || echo "{}")

            if [ -z "$RESPONSE" ]; then
              echo "‚ö†Ô∏è  Could not connect to API at ${API_HOST}:${API_PORT}"
              ATTEMPT=$((ATTEMPT + 1))
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting 5 minutes..."
              sleep 300
              continue
            fi

            SYNCED=$(echo "$RESPONSE" | grep -o '"synced":[^,}]*' | sed 's/"synced"://' | tr -d ' ')

            if [ "$SYNCED" = "true" ]; then
              echo "‚úÖ Indexer is synced and at tip"
              echo "synced=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "‚è≥ Indexer not synced yet (Attempt $ATTEMPT/$MAX_ATTEMPTS)"
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Waiting 5 minutes before next check..."
              sleep 300
            fi
          done

          echo "‚ùå ERROR: Indexer not synced after 1 hour"
          echo "synced=false" >> $GITHUB_OUTPUT
          exit 1

  create-snapshot:
    name: Create Database Snapshot
    runs-on: [snapshot-server-colo2]
    needs: [detect-network, check-sync-status]

    steps:
      - name: Pause yaci-indexer
        id: pause-indexer
        env:
          YACI_CONTAINER: ${{ needs.detect-network.outputs.yaci_container }}
        run: |
          echo "‚è∏Ô∏è  Pausing yaci-indexer to ensure consistent snapshot..."
          if docker pause "${YACI_CONTAINER}" 2>&1; then
            echo "‚úÖ Indexer paused"
            echo "paused=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Could not pause indexer - continuing anyway"
            echo "paused=false" >> $GITHUB_OUTPUT
          fi

      - name: Create snapshot using Docker Compose
        env:
          NETWORK: ${{ needs.detect-network.outputs.network }}
          ENV_FILE: ${{ needs.detect-network.outputs.env_file }}
        run: |
          cd /home/integration/git/cardano-rosetta-java

          echo "üöÄ Starting snapshot creation..."
          echo "   Network: ${NETWORK}"
          echo "   Env File: ${ENV_FILE}"

          docker compose -f docker-compose-snapshot.yaml \
            --env-file ${ENV_FILE} \
            up db-snapshot-create

          echo "‚úÖ Snapshot creation completed"

      - name: Resume yaci-indexer
        if: always()
        env:
          YACI_CONTAINER: ${{ needs.detect-network.outputs.yaci_container }}
        run: |
          echo "‚ñ∂Ô∏è  Resuming yaci-indexer..."
          if docker unpause "${YACI_CONTAINER}" 2>&1; then
            echo "‚úÖ Indexer resumed"
            sleep 5
            if docker ps --format '{{.Names}}\t{{.Status}}' | grep "${YACI_CONTAINER}"; then
              echo "‚úÖ Indexer is running normally"
            else
              echo "‚ö†Ô∏è  WARNING: Indexer may not be running properly"
            fi
          else
            echo "‚ö†Ô∏è  Could not unpause indexer"
            echo "‚ö†Ô∏è  Please manually resume: docker unpause ${YACI_CONTAINER}"
          fi
