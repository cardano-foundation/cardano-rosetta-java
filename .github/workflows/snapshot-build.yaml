name: Preprod Snapshot Creation

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_sync_check:
        description: 'Skip indexer sync check (use with caution)'
        required: false
        type: boolean
        default: false

  # Scheduled: Daily at midnight UTC
  schedule:
    - cron: '0 0 * * *'

env:
  SNAPSHOT_DIR: /home/integration/git/cardano-rosetta-java/snapshots
  COMPOSE_PROJECT_NAME: cardano-rosetta-java
  YACI_CONTAINER: cardano-rosetta-java-yaci-indexer-1
  API_HOST: localhost
  API_PORT: 8082
  NETWORK: preprod

jobs:
  check-sync-status:
    name: Check Indexer Sync Status
    runs-on: [preprod-snapshot-builder]
    outputs:
      is_synced: ${{ steps.sync-check.outputs.synced }}

    steps:
      - name: Check indexer is running
        run: |
          if ! docker ps --format '{{.Names}}' | grep -q "^${YACI_CONTAINER}$"; then
            echo "‚ùå ERROR: Indexer container '${YACI_CONTAINER}' is not running"
            exit 1
          fi
          echo "‚úÖ Indexer container is running"

      - name: Wait for indexer to sync
        id: sync-check
        if: ${{ !inputs.skip_sync_check }}
        run: |
          echo "üîç Checking indexer sync status..."
          MAX_ATTEMPTS=12  # Check every 5 minutes for 1 hour
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESPONSE=$(curl -s --location "${API_HOST}:${API_PORT}/network/status" \
              --header 'Content-Type: application/json' \
              --data "{
                \"network_identifier\": {
                  \"blockchain\": \"cardano\",
                  \"network\": \"${NETWORK}\"
                },
                \"metadata\": {}
              }" 2>/dev/null || echo "{}")

            if [ -z "$RESPONSE" ]; then
              echo "‚ö†Ô∏è  Could not connect to API at ${API_HOST}:${API_PORT}"
              ATTEMPT=$((ATTEMPT + 1))
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting 5 minutes..."
              sleep 300
              continue
            fi

            SYNCED=$(echo "$RESPONSE" | grep -o '"synced":[^,}]*' | sed 's/"synced"://' | tr -d ' ')

            if [ "$SYNCED" = "true" ]; then
              echo "‚úÖ Indexer is synced and at tip"
              echo "synced=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "‚è≥ Indexer not synced yet (Attempt $ATTEMPT/$MAX_ATTEMPTS)"
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Waiting 5 minutes before next check..."
              sleep 300
            fi
          done

          echo "‚ùå ERROR: Indexer not synced after 1 hour"
          echo "synced=false" >> $GITHUB_OUTPUT
          exit 1

  create-snapshot:
    name: Create Database Snapshot
    runs-on: [preprod-snapshot-builder]
    needs: check-sync-status

    steps:
      - name: Pause yaci-indexer
        id: pause-indexer
        run: |
          echo "‚è∏Ô∏è  Pausing yaci-indexer to ensure consistent snapshot..."
          if docker pause "${YACI_CONTAINER}" 2>&1; then
            echo "‚úÖ Indexer paused"
            echo "paused=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Could not pause indexer - continuing anyway"
            echo "paused=false" >> $GITHUB_OUTPUT
          fi

      - name: Create snapshot using Docker Compose
        run: |
          cd /home/integration/git/cardano-rosetta-java

          echo "üöÄ Starting snapshot creation..."
          docker compose -f docker-compose-snapshot.yaml \
            --env-file .env.docker-compose-preprod \
            up db-snapshot-create

          echo "‚úÖ Snapshot creation completed"

      - name: Resume yaci-indexer
        if: always()
        run: |
          echo "‚ñ∂Ô∏è  Resuming yaci-indexer..."
          if docker unpause "${YACI_CONTAINER}" 2>&1; then
            echo "‚úÖ Indexer resumed"
            sleep 5
            if docker ps --format '{{.Names}}\t{{.Status}}' | grep "${YACI_CONTAINER}"; then
              echo "‚úÖ Indexer is running normally"
            else
              echo "‚ö†Ô∏è  WARNING: Indexer may not be running properly"
            fi
          else
            echo "‚ö†Ô∏è  Could not unpause indexer"
            echo "‚ö†Ô∏è  Please manually resume: docker unpause ${YACI_CONTAINER}"
          fi

  cleanup-and-summary:
    name: Cleanup Old Snapshots
    runs-on: [preprod-snapshot-builder]
    needs: create-snapshot
    if: always()

    steps:
      - name: Clean up old snapshots
        run: |
          echo "üßπ Cleaning up snapshots older than 7 days..."
          find ${SNAPSHOT_DIR} -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true

          echo "üìä Current snapshots:"
          du -sh ${SNAPSHOT_DIR}/*/ 2>/dev/null || echo "No snapshot directories found"

      - name: Show latest snapshot
        if: success()
        run: |
          echo "‚úÖ Snapshot workflow completed successfully!"
          echo ""
          echo "üì¶ Latest snapshot files:"
          LATEST_DIR=$(ls -td ${SNAPSHOT_DIR}/*/ 2>/dev/null | head -1)
          if [ -n "$LATEST_DIR" ]; then
            ls -lh "$LATEST_DIR" | tail -n +2
            echo ""
            echo "üìÅ Location: $LATEST_DIR"

            # Show metadata if available
            METADATA_FILE=$(ls -t "$LATEST_DIR"/*.metadata.json 2>/dev/null | head -1)
            if [ -f "$METADATA_FILE" ]; then
              echo ""
              echo "üìã Snapshot metadata:"
              cat "$METADATA_FILE"
            fi
          else
            echo "‚ö†Ô∏è  No snapshots found in ${SNAPSHOT_DIR}"
          fi
